name: CI/CD 流水线

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: 在 ${{ matrix.os }} 上构建
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.3'
        host: ${{ matrix.os == 'windows-latest' && 'windows' || 'linux' }}
        target: desktop
        arch: ${{ matrix.os == 'windows-latest' && 'win64_msvc2022_64' || 'linux_gcc_64' }}
        dir: ${{ github.workspace }}/qt
        cache: true

    - name: 安装依赖 (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libgl1-mesa-dev libxcb-cursor0 libxkbcommon-dev libxcb-cursor0

    - name: 安装依赖 (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install make

    - name: 配置 CMake (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"
      shell: bash

    - name: 配置 CMake (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"
      shell: pwsh

    - name: 构建项目
      run: cmake --build build --config Release --parallel

    - name: 运行测试 (如果可用)
      run: |
        if [ -f build/huayan ] || [ -f build/huayan.exe ]; then
          echo "构建成功完成"
        else
          echo "可执行文件未找到，但构建可能仍在进行中"
        fi
      if: matrix.os == 'ubuntu-latest'

    - name: 运行测试 (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        if (Test-Path "build\huayan.exe") {
          Write-Host "构建成功完成"
        } else {
          Write-Host "可执行文件未找到"
        }
      shell: pwsh

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: huayan-scada-${{ matrix.os }}
        path: build/
        retention-days: 7