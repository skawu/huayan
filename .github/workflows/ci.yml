name: CI/CD 流水线

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: 在 ${{ matrix.os }} 上构建
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.3'
        arch: ${{ matrix.os == 'ubuntu-latest' ? 'gcc_64' : 'win64_msvc2022_64' }}
        cache: true

    - name: 安装依赖 (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libgl1-mesa-dev libxcb-cursor0

    - name: 配置 CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: 构建项目
      run: cmake --build build --config Release --parallel

    - name: 运行测试 (如果可用)
      run: |
        if [ -f build/test/run-tests ]; then
          cd build/test && ./run-tests
        else
          echo "未发现测试"
        fi
      if: matrix.os == 'ubuntu-latest'

    - name: 运行测试 (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        if (Test-Path "build\test\Release\run-tests.exe") {
          cd build\test\Release
          .\run-tests.exe
        } else {
          Write-Host "未发现测试"
        }
      shell: pwsh

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-build
        path: build/
        retention-days: 7